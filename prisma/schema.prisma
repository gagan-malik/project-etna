generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model accounts {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model conversations {
  id        String     @id @default(cuid())
  title     String?
  userId    String
  spaceId   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  spaces    spaces?    @relation(fields: [spaceId], references: [id])
  users     users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  messages[]
}

model document_indexes {
  id        String                 @id @default(cuid())
  title     String
  content   String
  url       String?
  source    String?
  sourceId  String?
  userId    String
  spaceId   String?
  embedding Unsupported("vector")?
  metadata  Json?
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  spaces    spaces?                @relation(fields: [spaceId], references: [id])
  users     users                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([source, sourceId])
  @@index([spaceId])
  @@index([userId])
}

model integrations {
  id          String   @id @default(cuid())
  type        String
  name        String
  userId      String
  spaceId     String?
  config      Json
  credentials Json?
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  spaces      spaces?  @relation(fields: [spaceId], references: [id])
  users       users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([userId])
}

model messages {
  id             String        @id @default(cuid())
  conversationId String
  role           String
  content        String
  model          String?
  provider       String?
  metadata       Json?
  createdAt      DateTime      @default(now())
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model sessions {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model spaces {
  id               String             @id @default(cuid())
  name             String
  description      String?
  slug             String             @unique
  ownerId          String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  conversations    conversations[]
  document_indexes document_indexes[]
  integrations     integrations[]
  design_files     design_files[]
  debug_sessions   debug_sessions[]
  waveform_files   waveform_files[]
  users            users              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model users {
  id                    String             @id @default(cuid())
  clerkId               String?            @unique // Clerk user id; set when user signs in via Clerk
  email                 String             @unique
  emailVerified         DateTime?
  name                  String?
  image                 String?
  password              String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  plan                  String?            @default("free")
  subscriptionStatus    String?
  subscriptionExpiresAt DateTime?
  userPreferences       Json?               // theme, notifications, privacyMode, etc. (see SETTINGS_PLAN.md)
  accounts              accounts[]
  conversations         conversations[]
  document_indexes      document_indexes[]
  integrations          integrations[]
  sessions              sessions[]
  spaces                spaces[]
  design_files          design_files[]
  debug_sessions        debug_sessions[]
  waveform_files        waveform_files[]
  user_commands         user_commands[]
  skills                skills[]
  workers               workers[]
}

// Commands: user-defined slash commands with prompt template; optional quick action
model user_commands {
  id                 String   @id @default(cuid())
  userId             String
  spaceId            String?
  name               String
  slug               String   // e.g. "debug-rtl"; unique per user (and space if set)
  promptTemplate     String   // may contain {{user_input}}
  showAsQuickAction  Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  users              users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@index([spaceId])
}

// Skills: system-prompt fragments; built-in (userId null) or user-created
model skills {
  id                   String   @id @default(cuid())
  userId               String?  // null = built-in
  name                 String
  description          String?
  systemPromptFragment String
  isBuiltIn            Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  users                users?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isBuiltIn])
}

// Workers: named subagents with own system prompt and optional model
model workers {
  id           String   @id @default(cuid())
  userId       String
  spaceId      String?
  name         String
  slug         String   // unique per user (and space if set)
  systemPrompt String
  modelId      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@index([spaceId])
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Silicon debugging models

model design_files {
  id             String           @id @default(cuid())
  name           String
  path           String
  type           String           // "rtl", "testbench", "constraint", "netlist"
  format         String           // "verilog", "vhdl", "systemverilog"
  content        String?
  spaceId        String
  userId         String
  metadata       Json?            // module hierarchy, signals, ports, etc.
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  spaces         spaces           @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  users          users            @relation(fields: [userId], references: [id], onDelete: Cascade)
  debug_sessions debug_sessions[]

  @@index([spaceId])
  @@index([userId])
  @@index([type])
  @@index([format])
}

model debug_sessions {
  id            String          @id @default(cuid())
  name          String
  description   String?
  status        String          @default("active") // "active", "completed", "failed"
  spaceId       String
  userId        String
  designFileId  String?
  waveformFileId String?
  config        Json?           // session configuration
  findings      Json?           // debug findings and notes
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  spaces        spaces          @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  users         users           @relation(fields: [userId], references: [id], onDelete: Cascade)
  design_files  design_files?   @relation(fields: [designFileId], references: [id], onDelete: SetNull)
  waveform_files waveform_files? @relation(fields: [waveformFileId], references: [id], onDelete: SetNull)

  @@index([spaceId])
  @@index([userId])
  @@index([status])
}

// Waveform files for silicon debugging
model waveform_files {
  id             String           @id @default(cuid())
  name           String           // original filename
  blobUrl        String           // Vercel Blob URL
  format         String           // "vcd", "fst", "ghw"
  fileSize       Int              // size in bytes
  spaceId        String
  userId         String
  metadata       Json?            // signal list, time range, etc.
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  spaces         spaces           @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  users          users            @relation(fields: [userId], references: [id], onDelete: Cascade)
  debug_sessions debug_sessions[]

  @@index([spaceId])
  @@index([userId])
  @@index([format])
}
