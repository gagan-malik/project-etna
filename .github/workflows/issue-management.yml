name: Issue Management

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  # Welcome new contributors
  welcome:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Check if first issue
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.issue.user.login;
            const opts = github.rest.issues.listForRepo.endpoint.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: creator,
              state: 'all'
            });
            const issues = await github.paginate(opts);
            if (issues.length === 1) {
              return 'true';
            }
            return 'false';
          result-encoding: string
      
      - name: Welcome first-time contributor
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üëã Welcome to project-etna, @${context.payload.issue.user.login}! Thanks for opening your first issue.
              
              A maintainer will review your issue soon. In the meantime:
              - Make sure you've provided all the requested information
              - Check out our [documentation](README.md) for common questions
              - Join our [discussions](https://github.com/${context.repo.owner}/${context.repo.repo}/discussions) for general questions
              
              We appreciate your contribution! üôè`
            });

  # Add labels based on issue content
  auto-label:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Auto-label based on title and content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const labelsToAdd = [];
            
            // Component detection
            if (title.includes('ui') || title.includes('button') || title.includes('component') || body.includes('ui/')) {
              labelsToAdd.push('component/ui');
            }
            if (title.includes('api') || title.includes('endpoint') || title.includes('route')) {
              labelsToAdd.push('component/api');
            }
            if (title.includes('auth') || title.includes('login') || title.includes('session')) {
              labelsToAdd.push('component/auth');
            }
            if (title.includes('database') || title.includes('prisma') || title.includes('query')) {
              labelsToAdd.push('component/database');
            }
            if (title.includes('ai') || title.includes('llm') || title.includes('gpt') || title.includes('openai')) {
              labelsToAdd.push('component/ai');
            }
            
            // Severity detection for bugs
            if (issue.labels.some(l => l.name === 'bug')) {
              if (body.includes('critical') || body.includes('unusable')) {
                labelsToAdd.push('priority/critical');
              } else if (body.includes('high') || body.includes('major')) {
                labelsToAdd.push('priority/high');
              }
            }
            
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labelsToAdd
              });
            }

  # Mark stale issues
  stale:
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled' && github.event.label.name == 'needs-info'
    steps:
      - name: Add stale warning comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚è≥ This issue has been marked as **needs-info**. Please provide the requested information within 14 days, or this issue may be closed as stale.
              
              If you've already provided all necessary details, please let us know and we'll review again.`
            });

  # Thank contributors on issue close
  thank-on-close:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && github.event.issue.state_reason == 'completed'
    steps:
      - name: Thank contributor
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ This issue has been resolved! Thanks to everyone who contributed to the discussion.
              
              If this doesn't fully address your concern, feel free to reopen or create a new issue.`
            });
